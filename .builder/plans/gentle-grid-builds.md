# Builder.io自動起動設定プラン

## 目的
Builder.ioでプロジェクトを開いたときに、手動設定なしで自動的に開発サーバーが起動するようにする。

## 現在の状況

### 今回実施した手動セットアップ
1. **依存関係のインストール**
   - コマンド: `HUSKY=0 corepack pnpm install`
   - 理由: pnpmがインストールされていない環境でも`corepack`を使用してpnpmを実行
   - HUSKY=0: Git hooksのセットアップをスキップ（Builder.io環境では.gitディレクトリがない場合があるため）

2. **開発サーバーの起動**
   - コマンド: `corepack pnpm --filter module-navi dev`
   - 理由: monorepo内の`module-navi`アプリのみを起動（全てのアプリを起動すると重い）
   - ポート: 3000

3. **プロキシ設定**
   - ポート: 3000
   - Next.jsアプリが起動してBuilder.ioのiframeにプレビューが表示される

## 実装アプローチ

### 重要な前提知識
Builder.ioは、DevServerControlツールで設定した内容（setup_command, dev_command, proxy_port）を**自動的にプロジェクト設定として保存**します。

今回設定した内容：
- Setup command: `HUSKY=0 corepack pnpm install`
- Dev command: `corepack pnpm --filter module-navi dev`
- Proxy port: `3000`

これらは既にBuilder.ioのクラウド上に保存されているため、**次回このプロジェクトを開いたときに自動的に復元**されます。

### 追加で実装する内容

さらに確実性と保守性を高めるため、以下のファイルを作成します：

#### 1. `.builder/setup.sh`
- セットアップコマンドをスクリプト化
- 将来的な変更や他の開発者との共有を容易にする
- 内容:
  ```bash
  #!/bin/bash
  # Builder.io環境でのセットアップスクリプト
  # pnpmとHuskyの問題を回避してインストール
  HUSKY=0 corepack pnpm install
  ```

#### 2. `.builder/dev.sh`
- 開発サーバー起動コマンドをスクリプト化
- 内容:
  ```bash
  #!/bin/bash
  # Builder.io環境での開発サーバー起動スクリプト
  # module-naviアプリのみを起動（ポート3000）
  corepack pnpm --filter module-navi dev
  ```

#### 3. `.builder/README_JA.md`
- Builder.io環境での開発ガイド（日本語）
- トラブルシューティング情報
- 設定の説明

### なぜこれらのファイルが必要か？

1. **ドキュメント化**: 設定内容を明示的に記録
2. **バックアップ**: Builder.io設定が失われた場合の復旧用
3. **チーム共有**: 他の開発者がBuilder.ioで開発する際のガイド
4. **保守性**: 将来的な設定変更を容易にする

## 素人にも分かるセットアップ手順の説明（日本語・初心者向け）

### 前提知識：このプロジェクトの構造

このプロジェクトは「**モノレポ**」という形式で管理されています。

```
sidekick/（プロジェクト全体）
├── apps/（アプリケーション群）
│   ├── module-navi/    ← 今回起動したアプリ（ドキュメント表示用）
│   └── documents/      ← もう1つのアプリ
├── packages/（共通ライブラリ群）
│   ├── ecm/           ← コンポーネントライブラリ
│   ├── scm/           ← コンポーネントライブラリ
│   └── ...
└── package.json       ← プロジェクト全体の設定
```

**モノレポとは？**
複数のアプリやライブラリを1つのリポジトリで管理する方法です。それぞれが独立して動作しますが、コードを共有できます。

### これまでに実施したこと（ステップバイステップ）

#### ステップ1: 問題の発見
Builder.ioでプロジェクトを開いたとき、以下のエラーが発生していました：
```
Dev server command is not configured
```

**原因**: Builder.ioの環境は「まっさら」な状態で、以下が設定されていませんでした：
- 依存関係のインストール方法
- 開発サーバーの起動方法
- どのポートでアプリを起動するか

#### ステップ2: 依存関係のインストール
**やったこと**: プロジェクトに必要なライブラリを全てインストール

**コマンド**:
```bash
HUSKY=0 corepack pnpm install
```

**詳しい解説**:
- `corepack`: Node.jsに標準で入っている機能。pnpmを自動的に使えるようにする
- `pnpm`: Node.jsのパッケージマネージャー（npmの高速版）
- `install`: 必要なライブラリを全てインストールするコマンド
- `HUSKY=0`: Git関連のツール（Husky）を無効化して、エラーを回避

**結果**: 1,686個のパッケージ（ライブラリ）がインストールされました

#### ステップ3: 開発サーバーの起動設定
**やったこと**: どのアプリをどのように起動するか設定

**コマンド**:
```bash
corepack pnpm --filter module-navi dev
```

**詳しい解説**:
- `--filter module-navi`: module-naviアプリ**だけ**を起動する
  - なぜ？全部起動すると重くなるため
  - module-naviは、ECMとSCMのドキュメントを表示するアプリ
- `dev`: 開発モードで起動（ファイルを変更すると自動的に反映される）

**結果**: Next.js（Reactのフレームワーク）がポート3000で起動

#### ステップ4: プロキシポートの設定
**やったこと**: Builder.ioのプレビューをどのポートに接続するか設定

**設定内容**:
- ポート: `3000`
- アクセス先: `http://localhost:3000`

**詳しい解説**:
Builder.ioは「プロキシ」という仕組みで、起動したアプリをiframeに表示します。
プロキシポートを3000に設定することで、Next.jsアプリの画面が見えるようになります。

#### ステップ5: 自動化のための設定ファイル作成（これから実施）
**やること**: 次回からは自動で起動するように設定

**解決策**:
- `.builder/`フォルダに設定ファイル（スクリプト）を作成
- Builder.ioが設定を保存（クラウド上）
- 次回からは自動的に同じ設定で起動

---

### 重要なポイント

1. **Builder.ioは設定を記憶する**
   - 今回設定した内容（setup command, dev command, proxy port）は自動保存される
   - 次回開いたときに自動的に復元される

2. **初回は時間がかかる**
   - 依存関係のインストールに1-2分かかる
   - 2回目以降は既にインストール済みなので速い

3. **module-naviだけ起動する理由**
   - プロジェクト全体（`pnpm dev`）を起動すると、3つのアプリが同時起動
   - Builder.ioでは1つずつ起動する方が軽量で推奨

## 実装手順

### ステップ1: `.builder/` ディレクトリを作成
プロジェクトルートに `.builder/` フォルダを作成します。

### ステップ2: セットアップスクリプトを作成
`.builder/setup.sh` を作成し、実行権限を付与します。

**ファイル内容**:
```bash
#!/bin/bash
set -e  # エラーが発生したら停止

echo "🔧 Builder.io環境のセットアップを開始します..."
echo "📦 pnpmを使用して依存関係をインストールします..."

# HUSKYを無効化してインストール（Git hooksのエラーを回避）
HUSKY=0 corepack pnpm install

echo "✅ セットアップが完了しました！"
```

### ステップ3: 開発サーバー起動スクリプトを作成
`.builder/dev.sh` を作成し、実行権限を付与します。

**ファイル内容**:
```bash
#!/bin/bash
set -e  # エラーが発生したら停止

echo "🚀 module-naviアプリの開発サーバーを起動します..."
echo "📍 ポート: 3000"

# module-naviアプリのみを起動
corepack pnpm --filter module-navi dev
```

### ステップ4: README（日本語ガイド）を作成
`.builder/README_JA.md` を作成し、Builder.io環境での開発方法を説明します。

**含める内容**:

1. **Builder.io開発環境とは**
   - クラウド上で動作する開発環境の説明
   - ローカル開発との違い

2. **自動起動の仕組み**
   - Builder.ioが設定を自動保存・復元する仕組み
   - 今回設定した内容（setup command, dev command, proxy port）の説明

3. **初回起動時の流れ**
   - 依存関係のインストール（1-2分）
   - 開発サーバーの起動
   - プレビューの表示

4. **トラブルシューティング**
   - 開発サーバーが起動しない場合
   - プレビューが表示されない場合
   - インストールが失敗する場合

5. **手動設定が必要な場合**
   - DevServerControlツールの使い方
   - 設定のリセット方法

6. **よくある質問（FAQ）**
   - Q: なぜHUSKY=0が必要なのか？
   - Q: なぜmodule-naviだけを起動するのか？
   - Q: 他のアプリ（documents, storybook）を起動したい場合は？

### ステップ5: 実行権限の付与
作成したシェルスクリプトに実行権限を付与します（Bashツールで実行）:
```bash
chmod +x .builder/setup.sh .builder/dev.sh
```

### ステップ6: 動作確認（オプション）
ローカルでスクリプトが正しく動作することを確認します。

## 期待される結果

### 次回以降、Builder.ioでこのプロジェクトを開いたとき

**1回目（初回起動時）**:
```
1. プロジェクトを開く
   ↓
2. 自動的にsetup.shが実行される
   → 依存関係のインストール（1-2分）
   ↓
3. 自動的にdev.shが実行される
   → module-naviアプリが起動
   ↓
4. プレビューに画面が表示される
   → http://localhost:3000の内容がiframeに表示
```

**2回目以降**:
```
1. プロジェクトを開く
   ↓
2. setup.shが実行される（高速、数秒）
   → 既にインストール済みのため、変更チェックのみ
   ↓
3. dev.shが実行される
   → module-naviアプリが起動（10-20秒）
   ↓
4. すぐにプレビューが表示される
```

### ユーザーがすること（何もなし！）

次回からは、プロジェクトを開くだけで以下が**自動的に**行われます：
- ✅ 依存関係のインストール確認
- ✅ 開発サーバーの起動
- ✅ プレビューの表示

**手動でコマンドを実行する必要は一切ありません！**

## 注意事項と補足情報

### 実行権限について
- `.builder/setup.sh`と`.builder/dev.sh`には実行権限（chmod +x）が必要です
- これを設定しないと、スクリプトが実行されません

### 初回起動時間について
- 初回起動時は依存関係のインストールに**1-2分**かかります
- これは正常な動作です、エラーではありません
- 進行状況はログに表示されます（`Progress: resolved X, downloaded Y...`）

### Git操作について
- Builder.ioは自動的にGit commitを作成します（各変更ごと）
- しかし、**自動的にはpushしません**
- 必要に応じて、画面右上の「Push」ボタンからpushしてください

### トラブルシューティング
もし開発サーバーが起動しない場合：
1. DevServerControlツールで「Get Logs」を確認
2. 必要に応じて「Restart」を実行
3. `.builder/README_JA.md`のトラブルシューティングセクションを参照

### 他のアプリを起動したい場合
- **documents**を起動したい場合:
  - Dev command: `corepack pnpm --filter documents dev`
  - Proxy port: `3003`

- **ECM Storybook**を起動したい場合:
  - Dev command: `corepack pnpm --filter ecm dev`
  - Proxy port: `8080`

- **全て同時に**起動したい場合（重いので非推奨）:
  - Dev command: `corepack pnpm dev`
  - 複数のポートが開く（3000, 3003, 8080, 8081）

---

## 次のステップ（実装フロー）

このプランを承認いただいた後、以下の順序で実装します：

1. **`.builder/`ディレクトリの作成**
   - プロジェクトルートに新規フォルダを作成

2. **`setup.sh`の作成**
   - セットアップスクリプトを記述
   - 実行権限を付与（chmod +x）

3. **`dev.sh`の作成**
   - 開発サーバー起動スクリプトを記述
   - 実行権限を付与（chmod +x）

4. **`README_JA.md`の作成**
   - Builder.io環境での開発ガイドを日本語で作成
   - トラブルシューティング、FAQ、使い方を記載

5. **動作確認（オプション）**
   - 作成したスクリプトがローカルで正しく動作するか確認

6. **Git commit**
   - 作成したファイルをcommit
   - 次回プロジェクトを開いたときに反映される

**所要時間**: 約5-10分

**影響範囲**: 新規ファイルのみ（既存コードには影響なし）

**リスク**: なし（スクリプトファイルとドキュメントの追加のみ）
